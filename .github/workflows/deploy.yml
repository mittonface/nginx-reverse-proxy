name: Deploy Nginx Reverse Proxy

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  validate:
    name: Validate Configuration
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Validate nginx configuration
        run: |
          # Test nginx config syntax
          docker run --rm -v $PWD/nginx.conf:/etc/nginx/nginx.conf:ro nginx:alpine nginx -t
          docker run --rm -v $PWD/nginx-initial.conf:/etc/nginx/nginx.conf:ro nginx:alpine nginx -t

      - name: Validate docker-compose
        run: |
          # Check docker-compose syntax
          docker-compose config -q

  deploy:
    name: Deploy to Server
    runs-on: ubuntu-latest
    needs: validate
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Copy files to server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          source: "nginx.conf,nginx-initial.conf,docker-compose.yml,deploy.sh,init-letsencrypt.sh,.env.example,README.md"
          target: "/root/nginx-reverse-proxy"
          strip_components: 0

      - name: Deploy reverse proxy
        uses: appleboy/ssh-action@v0.1.10
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          script: |
            cd /root/nginx-reverse-proxy
            
            # Ensure .env file exists
            if [ ! -f .env ]; then
              echo "‚ùå .env file not found on server!"
              echo "Please create .env file with:"
              echo "  HOUSE_TEMP_DOMAIN=${{ secrets.HOUSE_TEMP_DOMAIN }}"
              echo "  CAMERA_DOMAIN=${{ secrets.CAMERA_DOMAIN }}"
              exit 1
            fi
            
            # Create shared network if it doesn't exist
            docker network create proxy-network 2>/dev/null || true
            
            # Stop existing containers gracefully
            docker-compose down --timeout 30 || true
            
            # Pull external images
            docker pull nginx:alpine || true
            docker pull certbot/certbot || true
            
            # Configure SSL based on certificate availability
            if [ -f "certbot/conf/live/${{ secrets.HOUSE_TEMP_DOMAIN }}/fullchain.pem" ] && \
               [ -f "certbot/conf/live/${{ secrets.CAMERA_DOMAIN }}/fullchain.pem" ]; then
              echo "‚úÖ SSL certificates found for both domains, using HTTPS configuration"
              cp nginx.conf nginx.conf.active
            else
              echo "‚ÑπÔ∏è  SSL certificates not found for all domains, using HTTP configuration"
              cp nginx-initial.conf nginx.conf.active
            fi
            
            # Update docker-compose to use active config
            sed -i 's|nginx.conf:/etc/nginx/nginx.conf.template|nginx.conf.active:/etc/nginx/nginx.conf.template|g' docker-compose.yml
            
            # Start services
            docker-compose up -d
            
            # Clean up old images
            docker image prune -f --filter "until=24h"

      - name: Health check
        uses: appleboy/ssh-action@v0.1.10
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          script: |
            echo "üîÑ Performing health check..."
            
            # Wait for services to initialize
            sleep 15
            
            # Health check with retries
            for i in {1..6}; do
              echo "Health check attempt $i/6..."
              
              # Test both domains
              house_temp_ok=false
              camera_ok=false
              
              if curl -f -s --max-time 10 -H "Host: ${{ secrets.HOUSE_TEMP_DOMAIN }}" http://localhost >/dev/null 2>&1; then
                house_temp_ok=true
              fi
              
              if curl -f -s --max-time 10 -H "Host: ${{ secrets.CAMERA_DOMAIN }}" http://localhost >/dev/null 2>&1; then
                camera_ok=true
              fi
              
              if [ "$house_temp_ok" = true ] && [ "$camera_ok" = true ]; then
                echo "‚úÖ Both services are healthy and responding!"
                echo "üè† House Temp Tracker: http://${{ secrets.HOUSE_TEMP_DOMAIN }}"
                echo "üì∑ Camera Viewer: http://${{ secrets.CAMERA_DOMAIN }}"
                echo "üöÄ Deployment completed successfully!"
                exit 0
              elif [ $i -eq 6 ]; then
                echo "‚ùå Health check failed after $i attempts"
                echo "House Temp Tracker: $($house_temp_ok && echo '‚úÖ' || echo '‚ùå')"
                echo "Camera Viewer: $($camera_ok && echo '‚úÖ' || echo '‚ùå')"
                echo "üìã Container logs:"
                docker-compose logs --tail=30
                echo "üìä Container status:"
                docker-compose ps
                exit 1
              else
                echo "‚è≥ Services not ready, waiting 15 seconds..."
                echo "House Temp Tracker: $($house_temp_ok && echo '‚úÖ' || echo '‚ùå')"
                echo "Camera Viewer: $($camera_ok && echo '‚úÖ' || echo '‚ùå')"
                sleep 15
              fi
            done

      - name: SSL Certificate Status
        uses: appleboy/ssh-action@v0.1.10
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          script: |
            cd /root/nginx-reverse-proxy
            
            echo "üîí SSL Certificate Status:"
            
            for domain in "${{ secrets.HOUSE_TEMP_DOMAIN }}" "${{ secrets.CAMERA_DOMAIN }}"; do
              if [ -f "certbot/conf/live/${domain}/fullchain.pem" ]; then
                echo "‚úÖ ${domain}: SSL certificate exists"
                # Check expiration
                docker run --rm -v $PWD/certbot/conf:/etc/letsencrypt certbot/certbot certificates | grep -A 5 "$domain" || true
              else
                echo "‚ùå ${domain}: No SSL certificate found"
              fi
            done
            
            if [ ! -f "certbot/conf/live/${{ secrets.HOUSE_TEMP_DOMAIN }}/fullchain.pem" ] || \
               [ ! -f "certbot/conf/live/${{ secrets.CAMERA_DOMAIN }}/fullchain.pem" ]; then
              echo ""
              echo "üìù To set up SSL certificates, run: ./init-letsencrypt.sh"
              echo "   Make sure DNS records point to this server first!"
            fi