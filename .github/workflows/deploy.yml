name: Deploy Nginx Reverse Proxy

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  validate:
    name: Validate Configuration
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Validate nginx configuration
        run: |
          # Test nginx-initial.conf (HTTP only)
          docker run --rm -v $PWD/nginx-initial.conf:/etc/nginx/nginx.conf:ro nginx:alpine nginx -t
          
          # Create temporary SSL files for HTTPS config testing
          mkdir -p temp-ssl/live/temps.mittn.ca temp-ssl/live/camera.mittn.ca
          
          # Create valid self-signed certificates for testing (small key size for speed)
          openssl req -x509 -nodes -days 1 -newkey rsa:1024 \
            -keyout temp-ssl/live/temps.mittn.ca/privkey.pem \
            -out temp-ssl/live/temps.mittn.ca/fullchain.pem \
            -subj "/CN=temps.mittn.ca" 2>/dev/null
          
          openssl req -x509 -nodes -days 1 -newkey rsa:1024 \
            -keyout temp-ssl/live/camera.mittn.ca/privkey.pem \
            -out temp-ssl/live/camera.mittn.ca/fullchain.pem \
            -subj "/CN=camera.mittn.ca" 2>/dev/null
          
          # Download real Let's Encrypt configuration files
          curl -s https://raw.githubusercontent.com/certbot/certbot/master/certbot-nginx/certbot_nginx/_internal/tls_configs/options-ssl-nginx.conf > temp-ssl/options-ssl-nginx.conf
          curl -s https://raw.githubusercontent.com/certbot/certbot/master/certbot/certbot/ssl-dhparams.pem > temp-ssl/ssl-dhparams.pem
          
          # Test nginx.conf with dummy SSL files
          docker run --rm \
            -v $PWD/nginx.conf:/etc/nginx/nginx.conf:ro \
            -v $PWD/temp-ssl:/etc/letsencrypt:ro \
            nginx:alpine nginx -t
          
          # Clean up
          rm -rf temp-ssl

      - name: Validate docker-compose
        run: |
          # Check docker-compose syntax
          docker-compose config -q

  deploy:
    name: Deploy to Server
    runs-on: ubuntu-latest
    needs: validate
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Copy files to server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          source: "nginx.conf,nginx-initial.conf,docker-compose.yml,deploy.sh,init-letsencrypt.sh,README.md,Makefile"
          target: "/root/nginx-reverse-proxy"
          strip_components: 0

      - name: Deploy reverse proxy
        uses: appleboy/ssh-action@v0.1.10
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          script: |
            cd /root/nginx-reverse-proxy
            
            # Create shared network if it doesn't exist
            docker network create proxy-network 2>/dev/null || true
            
            # Stop existing containers gracefully
            docker-compose down --timeout 30 || true
            
            # Pull external images
            docker pull nginx:alpine || true
            docker pull certbot/certbot || true
            
            # Configure SSL based on certificate availability
            if [ -f "certbot/conf/live/temps.mittn.ca/fullchain.pem" ] && \
               [ -f "certbot/conf/live/camera.mittn.ca/fullchain.pem" ]; then
              echo "âœ… SSL certificates found for both domains, using HTTPS configuration"
              cp nginx.conf nginx.conf.active
            else
              echo "â„¹ï¸  SSL certificates not found for all domains, using HTTP configuration"
              cp nginx-initial.conf nginx.conf.active
            fi
            
            # Update docker-compose to use active config
            sed -i 's|nginx.conf:/etc/nginx/nginx.conf|nginx.conf.active:/etc/nginx/nginx.conf|g' docker-compose.yml
            
            # Start services
            docker-compose up -d
            
            # Clean up old images
            docker image prune -f --filter "until=24h"

      - name: Health check
        uses: appleboy/ssh-action@v0.1.10
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          script: |
            echo "ğŸ”„ Performing health check..."
            
            # Wait for services to initialize
            sleep 15
            
            # Health check with retries
            for i in {1..6}; do
              echo "Health check attempt $i/6..."
              
              # Test both domains
              house_temp_ok=false
              camera_ok=false
              
              if curl -f -s --max-time 10 -H "Host: temps.mittn.ca" http://localhost >/dev/null 2>&1; then
                house_temp_ok=true
              fi
              
              if curl -f -s --max-time 10 -H "Host: camera.mittn.ca" http://localhost >/dev/null 2>&1; then
                camera_ok=true
              fi
              
              if [ "$house_temp_ok" = true ] && [ "$camera_ok" = true ]; then
                echo "âœ… Both services are healthy and responding!"
                echo "ğŸ  House Temp Tracker: http://temps.mittn.ca"
                echo "ğŸ“· Camera Viewer: http://camera.mittn.ca"
                echo "ğŸš€ Deployment completed successfully!"
                exit 0
              elif [ $i -eq 6 ]; then
                echo "âŒ Health check failed after $i attempts"
                echo "House Temp Tracker: $($house_temp_ok && echo 'âœ…' || echo 'âŒ')"
                echo "Camera Viewer: $($camera_ok && echo 'âœ…' || echo 'âŒ')"
                echo "ğŸ“‹ Container logs:"
                docker-compose logs --tail=30
                echo "ğŸ“Š Container status:"
                docker-compose ps
                exit 1
              else
                echo "â³ Services not ready, waiting 15 seconds..."
                echo "House Temp Tracker: $($house_temp_ok && echo 'âœ…' || echo 'âŒ')"
                echo "Camera Viewer: $($camera_ok && echo 'âœ…' || echo 'âŒ')"
                sleep 15
              fi
            done

      - name: SSL Certificate Status
        uses: appleboy/ssh-action@v0.1.10
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          script: |
            cd /root/nginx-reverse-proxy
            
            echo "ğŸ”’ SSL Certificate Status:"
            
            for domain in "temps.mittn.ca" "camera.mittn.ca"; do
              if [ -f "certbot/conf/live/${domain}/fullchain.pem" ]; then
                echo "âœ… ${domain}: SSL certificate exists"
                # Check expiration
                docker run --rm -v $PWD/certbot/conf:/etc/letsencrypt certbot/certbot certificates | grep -A 5 "$domain" || true
              else
                echo "âŒ ${domain}: No SSL certificate found"
              fi
            done
            
            if [ ! -f "certbot/conf/live/temps.mittn.ca/fullchain.pem" ] || \
               [ ! -f "certbot/conf/live/camera.mittn.ca/fullchain.pem" ]; then
              echo ""
              echo "ğŸ“ To set up SSL certificates, run: ./init-letsencrypt.sh"
              echo "   Make sure DNS records point to this server first!"
            fi